{% load static %}
{% include 'components/navbar.html' %}

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm" type="module"></script>

<!-- Gizli dosya input -->
<input type="file" id="photoInput" accept="image/*" style="display: none;">

<section class="mx-auto max-w-7xl py-20 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Sol kısım -->
  <div class="lg:col-span-1 flex flex-col gap-8">
    <!-- Avatar ve isim -->
    <div class="border border-main bg-black bg-opacity-20 rounded-2xl p-6 flex flex-col items-center relative">
      <div class="relative w-40 h-40 rounded-full overflow-hidden border-4 border-main">
        <img id="userAvatar" src="https://via.placeholder.com/160x160/1ABC9C/FFFFFF?text=U" alt="Kullanıcı Avatarı" class="w-full h-full object-cover">
        
        <!-- Yükleme overlay -->
        <div id="uploadOverlay" class="hidden absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div class="text-white text-center">
            <svg class="animate-spin h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-xs">Yükleniyor...</p>
          </div>
        </div>
        
        <!-- Edit ikon -->
        <button id="photoEditBtn" class="absolute bottom-2 right-2 bg-main p-2 rounded-full hover:bg-main/80 transition">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 text-black">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6.586-6.586a2 2 0 112.828 2.828L11.828 15.828H9v-2.828z" />
          </svg>
        </button>
      </div>
      <h2 id="userName" class="text-4xl font-bold my-8 leading-normal tracking-[0.8px] text-white">Yükleniyor...</h2>
    </div>

    <!-- Rozet ve streak -->
    <div class="border border-main bg-black bg-opacity-20 rounded-2xl p-6 flex flex-col items-center">
      <h3 class="text-3xl font-semibold mb-4 leading-normal tracking-[0.8px] text-white">Başarılar</h3>
      <p class="font-extralight text-gray-300 text-md tracking-[0.8px] text-justify">
        Toplam 5 rozet kazandın ve 32 günlük streak yakaladın.
      </p>
      <div class="flex gap-3 mt-4">
        <img src="/path/to/badge1.png" class="w-10 h-10" alt="Rozet">
        <img src="/path/to/badge2.png" class="w-10 h-10" alt="Rozet">
      </div>
    </div>
  </div>

  <!-- Sağ kısım -->
  <div class="lg:col-span-2 flex flex-col gap-8">
    <!-- Kullanıcı bilgileri -->
    <div class="border border-main bg-black bg-opacity-20 rounded-2xl p-6">
      <h3 class="text-3xl font-semibold mb-8 leading-normal tracking-[0.8px] text-white">Kullanıcı Bilgileri</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 font-extralight text-gray-300 text-md tracking-[0.8px]">
        <p><span class="font-semibold text-white">Ad Soyad:</span> <span id="userFullName">Yükleniyor...</span></p>
        <p><span class="font-semibold text-white">Email:</span> <span id="userEmail">Yükleniyor...</span></p>
        <p><span class="font-semibold text-white">Kullanıcı Adı:</span> <span id="userUsername">Yükleniyor...</span></p>
        <p><span class="font-semibold text-white">Ülke:</span> <span id="userCountry">Yükleniyor...</span></p>
        <p><span class="font-semibold text-white">Yaş:</span> <span id="userAge">Yükleniyor...</span></p>
        <p><span class="font-semibold text-white">Cinsiyet:</span> <span id="userGender">Yükleniyor...</span></p>
      </div>
      <div class="flex items-end justify-end pt-2">
        <button id="editButton" class="bg-black-20 border-main border px-4 py-2 rounded-full hover:bg-second">Düzenle</button>
        <button id="logoutButton" class="bg-red-600 border-red-600 border px-4 py-2 rounded-full hover:bg-red-700 ml-2">Çıkış Yap</button>
      </div>
    </div>

    <!-- Egzersiz geçmişi -->
    <div class="border border-main bg-black bg-opacity-20 rounded-2xl p-6">
      <h3 class="text-3xl font-semibold mb-4 leading-normal tracking-[0.8px] text-white">Egzersiz Geçmişi</h3>

      <!-- Tab butonları -->
      <div class="flex flex-wrap gap-4 my-8">
        <button data-target="hafiza"
          class="tab-btn px-6 py-3 rounded-full border border-main text-white hover:bg-main/20 transition active">
          Hafıza
        </button>
        <button data-target="yaraticilik"
          class="tab-btn px-6 py-3 rounded-full border border-main text-white hover:bg-main/20 transition">
          Yaratıcılık
        </button>
        <button data-target="elestirel"
          class="tab-btn px-6 py-3 rounded-full border border-main text-white hover:bg-main/20 transition">
          Eleştirel Düşünme
        </button>
        <button data-target="stratejik"
          class="tab-btn px-6 py-3 rounded-full border border-main text-white hover:bg-main/20 transition">
          Stratejik Düşünme
        </button>
      </div>

      <!-- Tab içerikleri -->
      <div id="hafiza" class="tab-content font-extralight text-gray-300 text-md tracking-[0.8px] text-justify">
        <p class="mb-2">Toplam <span class="text-white font-semibold">24</span> hafıza egzersizi çözdün.</p>
        <p>Bu egzersizler, kısa süreli belleğini güçlendirdi ve bilgileri hızlı hatırlama yeteneğini artırdı.</p>
      </div>

      <div id="yaraticilik" class="tab-content hidden font-extralight text-gray-300 text-md tracking-[0.8px] text-justify">
        <p class="mb-2">Toplam <span class="text-white font-semibold">12</span> yaratıcılık egzersizi çözdün.</p>
        <p>Farklı bakış açıları geliştirdin, problem çözmede özgün fikirler üretebilir hale geldin.</p>
      </div>

      <div id="elestirel" class="tab-content hidden font-extralight text-gray-300 text-md tracking-[0.8px] text-justify">
        <p class="mb-2">Toplam <span class="text-white font-semibold">18</span> eleştirel düşünme egzersizi çözdün.</p>
        <p>Olaylara daha mantıklı ve sorgulayıcı yaklaşabiliyorsun, analiz gücün belirgin şekilde gelişti.</p>
      </div>

      <div id="stratejik" class="tab-content hidden font-extralight text-gray-300 text-md tracking-[0.8px] text-justify">
        <p class="mb-2">Toplam <span class="text-white font-semibold">9</span> stratejik düşünme egzersizi çözdün.</p>
        <p>Hedef belirleme ve plan yapma becerin güçlendi, daha sistematik kararlar verebiliyorsun.</p>
      </div>
    </div>
  </div>
</section>

<script>
  // Tab sistemi
  const tabs = document.querySelectorAll('.tab-btn');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // aktif butonu değiştir
      tabs.forEach(t => t.classList.remove('active', 'bg-main/20'));
      tab.classList.add('active', 'bg-main/20');

      // içerikleri değiştir
      const target = tab.getAttribute('data-target');
      contents.forEach(c => {
        if (c.id === target) {
          c.classList.remove('hidden');
        } else {
          c.classList.add('hidden');
        }
      });
    });
  });
</script>

<!-- Supabase ve Profil Fotoğrafı Scripti -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabaseUrl = 'https://enromkgseckujzrwmmjp.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVucm9ta2dzZWNrdWp6cndtbWpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTIyMjUsImV4cCI6MjA2ODA4ODIyNX0.sjVQSczSs1bLE0QLgMyuWQFycACr2hh3rfyJar1P-0M'
  const supabase = createClient(supabaseUrl, supabaseKey)

  let currentUser = null

  // Sayfa yüklendiğinde kullanıcı bilgilerini çek
  async function loadUserProfile() {
    try {
      // Mevcut kullanıcıyı al
      const { data: { user }, error } = await supabase.auth.getUser()
      
      if (error || !user) {
        console.error('Kullanıcı bulunamadı:', error)
        window.location.href = '/login/'
        return
      }

      currentUser = user
      const userData = user.user_metadata
      
      // Kullanıcı bilgilerini DOM'a yerleştir
      document.getElementById('userName').textContent = userData.full_name || 'İsim Girilmemiş'
      document.getElementById('userFullName').textContent = userData.full_name || 'İsim Girilmemiş'
      document.getElementById('userEmail').textContent = user.email || 'Email Girilmemiş'
      document.getElementById('userUsername').textContent = userData.username || 'Kullanıcı Adı Girilmemiş'
      document.getElementById('userCountry').textContent = userData.country || 'Ülke Girilmemiş'
      document.getElementById('userAge').textContent = userData.age || 'Yaş Girilmemiş'
      document.getElementById('userGender').textContent = userData.gender || 'Cinsiyet Girilmemiş'

      // Avatar yükle
      await loadUserAvatar(user.id, userData.full_name)

    } catch (error) {
      console.error('Profil yüklenirken hata:', error)
      window.location.href = '/login/'
    }
  }

  // Kullanıcı avatarını yükle
  async function loadUserAvatar(userId, fullName) {
    try {
      // Önce Supabase Storage'dan profil fotoğrafını kontrol et
      const { data, error } = await supabase.storage
        .from('avatars')
        .download(`${userId}/profile.jpg`)

      if (data && !error) {
        // Eğer fotoğraf varsa, blob'u URL'ye çevir
        const photoUrl = URL.createObjectURL(data)
        document.getElementById('userAvatar').src = photoUrl
      } else {
        // Eğer fotoğraf yoksa, placeholder kullan
        if (fullName) {
          const initials = fullName.split(' ').map(name => name[0]).join('').toUpperCase()
          document.getElementById('userAvatar').src = `https://via.placeholder.com/160x160/1ABC9C/FFFFFF?text=${initials}`
        }
      }
    } catch (error) {
      console.error('Avatar yükleme hatası:', error)
      // Hata durumunda placeholder kullan
      if (fullName) {
        const initials = fullName.split(' ').map(name => name[0]).join('').toUpperCase()
        document.getElementById('userAvatar').src = `https://via.placeholder.com/160x160/1ABC9C/FFFFFF?text=${initials}`
      }
    }
  }

  // Fotoğraf yükleme fonksiyonu
  async function uploadPhoto(file) {
    if (!currentUser) return

    try {
      // Yükleme overlay'ini göster
      document.getElementById('uploadOverlay').classList.remove('hidden')

      // Dosya boyutu kontrolü (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        throw new Error('Dosya boyutu 5MB\'dan küçük olmalıdır.')
      }

      // Dosya tipini kontrol et
      if (!file.type.startsWith('image/')) {
        throw new Error('Sadece resim dosyaları yüklenebilir.')
      }

      // Dosyayı Supabase Storage'a yükle
      const fileExt = file.name.split('.').pop()
      const fileName = `${currentUser.id}/profile.${fileExt}`

      const { error: uploadError } = await supabase.storage
        .from('avatars')
        .upload(fileName, file, { 
          upsert: true,
          cacheControl: '3600'
        })

      if (uploadError) {
        throw uploadError
      }

      // Yeni fotoğrafı hemen göster
      const photoUrl = URL.createObjectURL(file)
      document.getElementById('userAvatar').src = photoUrl

      alert('Profil fotoğrafı başarıyla güncellendi!')

    } catch (error) {
      console.error('Fotoğraf yükleme hatası:', error)
      alert('Fotoğraf yüklenirken hata oluştu: ' + error.message)
    } finally {
      // Yükleme overlay'ini gizle
      document.getElementById('uploadOverlay').classList.add('hidden')
    }
  }

  // Event Listeners
  
  // Fotoğraf düzenleme butonuna tıklama
  document.getElementById('photoEditBtn').addEventListener('click', () => {
    document.getElementById('photoInput').click()
  })

  // Dosya seçildiğinde
  document.getElementById('photoInput').addEventListener('change', (e) => {
    const file = e.target.files[0]
    if (file) {
      uploadPhoto(file)
    }
  })

  // Çıkış yap fonksiyonu
  document.getElementById('logoutButton').addEventListener('click', async () => {
    const { error } = await supabase.auth.signOut()
    if (error) {
      console.error('Çıkış hatası:', error)
    } else {
      localStorage.removeItem('user_session')
      window.location.href = '/login/'
    }
  })

  // Düzenle butonu (şimdilik alert)
  document.getElementById('editButton').addEventListener('click', () => {
    alert('Profil düzenleme özelliği yakında eklenecek!')
  })

  // Sayfa yüklendiğinde kullanıcı bilgilerini yükle
  window.addEventListener('load', loadUserProfile)
</script>

<!-- PROFILE SAYFASI İÇİN NAVBAR GÜNCELLEME SCRİPTİ -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabaseUrl = 'https://enromkgseckujzrwmmjp.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVucm9ta2dzZWNrdWp6cndtbWpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MTIyMjUsImV4cCI6MjA2ODA4ODIyNX0.sjVQSczSs1bLE0QLgMyuWQFycACr2hh3rfyJar1P-0M'
  const supabase = createClient(supabaseUrl, supabaseKey)

  // Profile sayfasında navbar'ı güncelle
  async function updateNavbarForProfile() {
    try {
      const { data: { user }, error } = await supabase.auth.getUser()
      
      if (error || !user) {
        console.error('Kullanıcı bulunamadı:', error)
        window.location.href = '/login/'
        return
      }

      // Navbar'daki giriş yap linklerini bul
      const desktopLoginBtn = document.querySelector('header a[href="login"]')
      const mobileLoginBtn = document.querySelector('#mobile-menu a[href="login"]')
      
      if (desktopLoginBtn || mobileLoginBtn) {
        const userData = user.user_metadata
        const fullName = userData.full_name || 'Kullanıcı'
        const firstName = fullName.split(' ')[0] // Sadece ilk ismi al
        
        // Kullanıcının isminin ilk harflerini al
        const initials = fullName.split(' ').map(name => name[0]).join('').toUpperCase()
        
        // Masaüstü için yeni HTML
        const desktopUserSection = `
          <div class="hidden md:flex items-center space-x-3">
            <div class="w-8 h-8 bg-main rounded-full flex items-center justify-center">
              <span class="text-black text-sm font-bold">${initials}</span>
            </div>
            <span class="text-white font-medium">Merhaba, ${firstName}</span>
            <div class="relative group">
              <button class="text-white hover:text-main transition ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <!-- Dropdown Menu -->
              <div class="hidden group-hover:block absolute right-0 mt-2 w-48 bg-black bg-opacity-90 border border-main rounded-lg shadow-lg z-50">
                <a href="/profile/" class="block px-4 py-2 text-white hover:bg-main hover:text-black transition">Profilim</a>
                <a href="#" class="block px-4 py-2 text-white hover:bg-main hover:text-black transition">Ayarlar</a>
                <hr class="border-gray-600">
                <button onclick="logoutUser()" class="w-full text-left px-4 py-2 text-white hover:bg-red-600 transition">Çıkış Yap</button>
              </div>
            </div>
          </div>
        `
        
        // Mobil için yeni HTML
        const mobileUserSection = `
          <div class="flex flex-col items-center space-y-2 md:hidden">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 bg-main rounded-full flex items-center justify-center">
                <span class="text-black text-sm font-bold">${initials}</span>
              </div>
              <span class="text-white font-medium">Merhaba, ${firstName}</span>
            </div>
            <div class="flex flex-col space-y-2">
              <a href="/profile/" class="text-white hover:text-main transition">Profilim</a>
              <a href="#" class="text-white hover:text-main transition">Ayarlar</a>
              <button onclick="logoutUser()" class="text-white hover:text-red-400 transition">Çıkış Yap</button>
            </div>
          </div>
        `
        
        // Masaüstü login butonunu değiştir
        if (desktopLoginBtn) {
          desktopLoginBtn.outerHTML = desktopUserSection
        }
        
        // Mobil login butonunu değiştir
        if (mobileLoginBtn) {
          mobileLoginBtn.outerHTML = mobileUserSection
        }
      }
      
    } catch (error) {
      console.error('Navbar güncelleme hatası:', error)
      window.location.href = '/login/'
    }
  }

  // Global çıkış fonksiyonu
  window.logoutUser = async function() {
    const { error } = await supabase.auth.signOut()
    if (error) {
      console.error('Çıkış hatası:', error)
    } else {
      localStorage.removeItem('user_session')
      window.location.href = '/login/'
    }
  }

  // Sayfa yüklendiğinde navbar'ı güncelle
  window.addEventListener('load', updateNavbarForProfile)
</script>

{% include 'components/footer.html' %}
  </body>
</html>